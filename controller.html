<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
<title>Tank Controller</title>
<link rel="icon" href="data:,">
<style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    html, body {
        width: 100%; height: 100%;
        overflow: hidden;
        background: #1a1a2e;
        color: #fff;
        font-family: Arial, sans-serif;
        touch-action: none;
        -webkit-user-select: none;
        user-select: none;
    }

    #header {
        text-align: center;
        padding: 12px 0 6px;
    }
    #header h1 {
        font-size: 22px;
        letter-spacing: 2px;
        color: #ddd;
    }
    #player-color {
        display: none;
        width: 16px; height: 16px;
        border-radius: 50%;
        margin-right: 8px;
        vertical-align: middle;
        border: 2px solid rgba(255,255,255,0.3);
    }
    #status {
        font-size: 14px;
        margin-top: 4px;
        color: #888;
    }
    #status .dot {
        display: inline-block;
        width: 10px; height: 10px;
        border-radius: 50%;
        background: #666;
        margin-right: 4px;
        vertical-align: middle;
    }
    #status .dot.connected { background: #33cc66; }
    #status .dot.connecting { background: #ffcc00; }

    #scene-label {
        text-align: center;
        font-size: 13px;
        color: #666;
        margin-top: 2px;
        letter-spacing: 1px;
    }

    #fs-toggle {
        position: absolute;
        top: 10px;
        right: 12px;
        width: 36px; height: 36px;
        border-radius: 8px;
        background: rgba(255,255,255,0.08);
        border: 1px solid rgba(255,255,255,0.15);
        color: #aaa;
        font-size: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 100;
        transition: background 0.15s;
    }
    #fs-toggle:active {
        background: rgba(255,255,255,0.2);
    }

    #controls {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: calc(100% - 90px);
        gap: 20px;
    }

    #sticks {
        display: flex;
        justify-content: space-around;
        width: 100%;
        padding: 0 20px;
    }

    .stick-container {
        position: relative;
        width: 150px; height: 150px;
        flex-shrink: 0;
    }
    .stick-base {
        position: absolute;
        top: 0; left: 0;
        width: 150px; height: 150px;
        border-radius: 50%;
        background: rgba(255,255,255,0.08);
        border: 2px solid rgba(255,255,255,0.15);
    }
    .stick-knob {
        position: absolute;
        width: 60px; height: 60px;
        border-radius: 50%;
        background: rgba(100,160,255,0.6);
        border: 2px solid rgba(100,160,255,0.9);
        top: 45px; left: 45px; /* centered */
        pointer-events: none;
        transition: background 0.1s;
    }
    .stick-label {
        position: absolute;
        bottom: -22px;
        width: 100%;
        text-align: center;
        font-size: 13px;
        color: #666;
        letter-spacing: 1px;
    }

    .action-btn {
        width: 200px;
        height: 70px;
        border-radius: 14px;
        color: #fff;
        font-size: 24px;
        font-weight: bold;
        letter-spacing: 3px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.08s, transform 0.08s;
        margin-top: 10px;
        border: 3px solid transparent;
    }
    .action-btn.pressed {
        transform: scale(0.96);
    }

    /* FIRE button style */
    #fire-btn {
        background: rgba(255, 60, 60, 0.35);
        border-color: rgba(255, 60, 60, 0.7);
    }
    #fire-btn.pressed {
        background: rgba(255, 60, 60, 0.7);
    }

    /* READY button style */
    #ready-btn {
        background: rgba(60, 200, 60, 0.25);
        border-color: rgba(60, 200, 60, 0.6);
    }
    #ready-btn.pressed, #ready-btn.active {
        background: rgba(60, 200, 60, 0.65);
    }

    /* SELECT button style (menu mode) */
    #select-btn {
        background: rgba(60, 200, 60, 0.25);
        border-color: rgba(60, 200, 60, 0.6);
    }
    #select-btn.pressed {
        background: rgba(60, 200, 60, 0.65);
    }

    .hidden { display: none !important; }

    /* Fullscreen prompt overlay */
    #fullscreen-prompt {
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(10, 10, 30, 0.95);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        gap: 20px;
        cursor: pointer;
    }
    #fullscreen-prompt .icon {
        font-size: 64px;
        opacity: 0.8;
    }
    #fullscreen-prompt .prompt-text {
        font-size: 22px;
        font-weight: bold;
        letter-spacing: 2px;
        color: #ddd;
    }
    #fullscreen-prompt .prompt-sub {
        font-size: 14px;
        color: #888;
        margin-top: -8px;
    }

    /* Landscape mode */
    @media (orientation: landscape) {
        #controls {
            flex-direction: column;
            gap: 10px;
        }
        /* Arena sticks: push to far edges */
        #mode-arena #sticks {
            justify-content: space-between;
            padding: 0 100px;
        }
        #mode-arena #sticks .stick-container {
            width: 130px; height: 130px;
        }
        #mode-arena #sticks .stick-base {
            width: 130px; height: 130px;
        }
        #mode-arena #sticks .stick-knob {
            width: 52px; height: 52px;
            top: 39px; left: 39px;
        }
        /* Arena fire button: full width */
        #mode-arena #fire-btn {
            width: calc(100vw - 20px);
            height: 60px;
            font-size: 22px;
        }
        /* Non-arena sticks & buttons in landscape */
        .stick-container {
            width: 130px; height: 130px;
        }
        .stick-base {
            width: 130px; height: 130px;
        }
        .stick-knob {
            width: 52px; height: 52px;
            top: 39px; left: 39px;
        }
        .action-btn {
            width: 180px; height: 60px;
            font-size: 20px;
        }
    }
</style>
</head>
<body>

<div id="fullscreen-prompt">
    <div class="icon">⛶</div>
    <div class="prompt-text">TAP TO GO FULLSCREEN</div>
    <div class="prompt-sub">For the best experience</div>
</div>

<div id="header">
    <h1><span id="player-color"></span>TANK CONTROLLER</h1>
    <div id="status"><span class="dot connecting"></span> Connecting...</div>
    <div id="scene-label"></div>
    <div id="fs-toggle" title="Toggle fullscreen">⛶</div>
</div>

<div id="controls">
    <!-- ===== ARENA MODE (default): two sticks + fire ===== -->
    <div id="mode-arena">
        <div id="sticks">
            <div class="stick-container" id="stick-left">
                <div class="stick-base"></div>
                <div class="stick-knob" id="knob-left"></div>
                <div class="stick-label">MOVE</div>
            </div>
            <div class="stick-container" id="stick-right">
                <div class="stick-base"></div>
                <div class="stick-knob" id="knob-right"></div>
                <div class="stick-label">AIM</div>
            </div>
        </div>
        <div id="fire-wrapper" style="display:flex;justify-content:center;margin-top:20px;width:100%;padding:0 10px;">
            <div id="fire-btn" class="action-btn">FIRE</div>
        </div>
    </div>

    <!-- ===== LOBBY MODE: one stick (move) + READY button ===== -->
    <div id="mode-lobby" class="hidden">
        <div id="sticks-lobby" style="display:flex;justify-content:center;width:100%;padding:0 20px;">
            <div class="stick-container" id="stick-left-lobby">
                <div class="stick-base"></div>
                <div class="stick-knob" id="knob-left-lobby"></div>
                <div class="stick-label">MOVE</div>
            </div>
        </div>
        <div style="display:flex;justify-content:center;margin-top:30px;">
            <div id="ready-btn" class="action-btn">READY</div>
        </div>
    </div>

    <!-- ===== MENU MODE: one stick (navigate) + SELECT button ===== -->
    <div id="mode-menu" class="hidden">
        <div style="display:flex;justify-content:center;width:100%;padding:0 20px;">
            <div class="stick-container" id="stick-left-menu">
                <div class="stick-base"></div>
                <div class="stick-knob" id="knob-left-menu"></div>
                <div class="stick-label">NAVIGATE</div>
            </div>
        </div>
        <div style="display:flex;justify-content:center;margin-top:30px;">
            <div id="select-btn" class="action-btn">SELECT</div>
        </div>
    </div>
</div>

<script>
// ---- Fullscreen prompt ----
(function() {
    const overlay = document.getElementById('fullscreen-prompt');
    overlay.addEventListener('click', () => {
        const el = document.documentElement;
        const rfs = el.requestFullscreen || el.webkitRequestFullscreen || el.msRequestFullscreen;
        if (rfs) {
            rfs.call(el).catch(() => {});
        }
        overlay.style.display = 'none';
    });
    // Also hide if already in fullscreen (e.g. PWA / standalone mode)
    if (window.matchMedia('(display-mode: fullscreen)').matches ||
        window.matchMedia('(display-mode: standalone)').matches ||
        window.navigator.standalone) {
        overlay.style.display = 'none';
    }
})();

// ---- Fullscreen toggle button ----
(function() {
    const btn = document.getElementById('fs-toggle');

    function updateIcon() {
        const isFs = !!document.fullscreenElement || !!document.webkitFullscreenElement;
        btn.textContent = isFs ? '✕' : '⛶';
        btn.title = isFs ? 'Exit fullscreen' : 'Enter fullscreen';
    }

    btn.addEventListener('click', () => {
        const isFs = !!document.fullscreenElement || !!document.webkitFullscreenElement;
        if (isFs) {
            (document.exitFullscreen || document.webkitExitFullscreen).call(document);
        } else {
            const el = document.documentElement;
            (el.requestFullscreen || el.webkitRequestFullscreen).call(el).catch(() => {});
        }
    });

    document.addEventListener('fullscreenchange', updateIcon);
    document.addEventListener('webkitfullscreenchange', updateIcon);
    updateIcon();
})();

// ---- State ----
const state = {
    axes: [0, 0, 0, 0],   // lx, ly, rx, ry
    buttons: new Array(17).fill(false)
};

let currentMode = 'arena'; // 'arena' | 'lobby' | 'menu'

// ---- WebSocket ----
let ws = null;
let playerId = null;

// WS player colors (matching game.js)
const WS_PLAYER_COLORS = [
    0x00cccc, // teal
    0xff00ff, // magenta
    0x00ff88, // spring green
    0xff6688, // coral pink
    0x88aaff, // periwinkle
    0xffaa00, // amber
    0xaa44ff, // violet
    0x44ff44, // bright green
    0xff4488, // hot pink
    0x00aaff, // sky blue
    0xffdd44, // gold
    0x44ffcc, // aquamarine
    0xff8844, // tangerine
    0xaa88ff, // lavender
    0x88ff44, // chartreuse
    0xcc4444, // scarlet
    0x44aaff, // cornflower
    0xcc44ff, // orchid
    0xff88cc, // pink
    0x44ffaa  // mint
];

function updatePlayerColor() {
    if (playerId === null) return;
    const colorHex = WS_PLAYER_COLORS[parseInt(playerId) % 20];
    const r = (colorHex >> 16) & 0xFF;
    const g = (colorHex >> 8) & 0xFF;
    const b = colorHex & 0xFF;
    const colorStr = `rgb(${r}, ${g}, ${b})`;
    const indicator = document.getElementById('player-color');
    indicator.style.backgroundColor = colorStr;
    indicator.style.display = 'inline-block';
}

function connectWS() {
    const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
    ws = new WebSocket(`${protocol}//${location.host}/ws/controller`);

    ws.onopen = () => updateStatus('connected');

    ws.onmessage = (e) => {
        try {
            const msg = JSON.parse(e.data);
            if (msg.type === 'id') {
                playerId = msg.id;
                updateStatus('connected');
                updatePlayerColor();
            } else if (msg.type === 'scene') {
                onSceneChange(msg.scene);
            }
        } catch (err) {}
    };

    ws.onclose = () => {
        updateStatus('disconnected');
        playerId = null;
        const indicator = document.getElementById('player-color');
        indicator.style.display = 'none';
        setTimeout(connectWS, 2000);
    };

    ws.onerror = () => {};
}

function onSceneChange(sceneName) {
    const label = document.getElementById('scene-label');
    if (sceneName === 'TeamLobbyScene') {
        setMode('lobby');
        label.textContent = 'Team Selection';
    } else if (sceneName === 'ArenaScene') {
        setMode('arena');
        label.textContent = 'In Game';
    } else if (sceneName === 'MenuScene') {
        setMode('menu');
        label.textContent = 'Main Menu';
    } else if (sceneName === 'WinnerScene') {
        setMode('menu');
        label.textContent = 'Results';
    } else if (sceneName === 'SettingsScene') {
        setMode('menu');
        label.textContent = 'Settings';
    } else {
        setMode('arena');
        label.textContent = '';
    }
}

function setMode(mode) {
    if (currentMode === mode) return;
    currentMode = mode;

    // Reset all state axes and buttons when switching modes
    state.axes = [0, 0, 0, 0];
    for (let i = 0; i < state.buttons.length; i++) state.buttons[i] = false;

    // Reset READY button visual state
    const readyBtn = document.getElementById('ready-btn');
    if (readyBtn) {
        readyBtn.classList.remove('active', 'pressed');
        readyBtn.textContent = 'READY';
    }

    // Show/hide mode panels
    document.getElementById('mode-arena').classList.toggle('hidden', mode !== 'arena');
    document.getElementById('mode-lobby').classList.toggle('hidden', mode !== 'lobby');
    document.getElementById('mode-menu').classList.toggle('hidden', mode !== 'menu');
}

function updateStatus(s) {
    const el = document.getElementById('status');
    const dot = el.querySelector('.dot');
    dot.className = 'dot';
    if (s === 'connected') {
        dot.classList.add('connected');
        el.innerHTML = '';
        el.appendChild(dot);
        el.append(` Connected` + (playerId !== null ? ` (WS${playerId})` : ''));
    } else if (s === 'disconnected') {
        dot.classList.remove('connected', 'connecting');
        el.innerHTML = '';
        el.appendChild(dot);
        el.append(' Reconnecting...');
    } else {
        dot.classList.add('connecting');
    }
}

// Send state at ~60fps
function sendLoop() {
    if (ws && ws.readyState === 1) {
        ws.send(JSON.stringify(state));
    }
    requestAnimationFrame(sendLoop);
}

connectWS();
requestAnimationFrame(sendLoop);

// ---- Virtual Sticks ----
function setupStick(containerId, knobId, axisX, axisY) {
    const container = document.getElementById(containerId);
    const knob = document.getElementById(knobId);
    let activeTouch = null;

    const baseSize = () => container.querySelector('.stick-base').getBoundingClientRect();

    function updateKnob(cx, cy, rect) {
        const radius = rect.width / 2;
        const knobRadius = knob.offsetWidth / 2;
        const maxDist = radius - knobRadius * 0.3;

        let dist = Math.sqrt(cx * cx + cy * cy);
        if (dist > maxDist) {
            cx = (cx / dist) * maxDist;
            cy = (cy / dist) * maxDist;
            dist = maxDist;
        }

        knob.style.left = (radius - knobRadius + cx) + 'px';
        knob.style.top = (radius - knobRadius + cy) + 'px';

        state.axes[axisX] = parseFloat((cx / maxDist).toFixed(3));
        state.axes[axisY] = parseFloat((cy / maxDist).toFixed(3));
    }

    function resetKnob() {
        const rect = baseSize();
        const radius = rect.width / 2;
        const knobRadius = knob.offsetWidth / 2;
        knob.style.left = (radius - knobRadius) + 'px';
        knob.style.top = (radius - knobRadius) + 'px';
        state.axes[axisX] = 0;
        state.axes[axisY] = 0;
    }

    container.addEventListener('touchstart', (e) => {
        e.preventDefault();
        if (activeTouch !== null) return;
        const touch = e.changedTouches[0];
        activeTouch = touch.identifier;
        const rect = baseSize();
        const cx = touch.clientX - rect.left - rect.width / 2;
        const cy = touch.clientY - rect.top - rect.height / 2;
        updateKnob(cx, cy, rect);
        knob.style.background = 'rgba(100,180,255,0.85)';
    }, { passive: false });

    container.addEventListener('touchmove', (e) => {
        e.preventDefault();
        for (const touch of e.changedTouches) {
            if (touch.identifier === activeTouch) {
                const rect = baseSize();
                const cx = touch.clientX - rect.left - rect.width / 2;
                const cy = touch.clientY - rect.top - rect.height / 2;
                updateKnob(cx, cy, rect);
            }
        }
    }, { passive: false });

    const endTouch = (e) => {
        for (const touch of e.changedTouches) {
            if (touch.identifier === activeTouch) {
                activeTouch = null;
                resetKnob();
                knob.style.background = 'rgba(100,160,255,0.6)';
            }
        }
    };

    container.addEventListener('touchend', endTouch);
    container.addEventListener('touchcancel', endTouch);

    resetKnob();
}

// Arena sticks
setupStick('stick-left', 'knob-left', 0, 1);
setupStick('stick-right', 'knob-right', 2, 3);

// Lobby stick (only left-stick / movement, same axes 0,1)
setupStick('stick-left-lobby', 'knob-left-lobby', 0, 1);

// ---- Fire Button (RT = buttons[7]) ----
(function() {
    const btn = document.getElementById('fire-btn');
    let activeTouch = null;

    btn.addEventListener('touchstart', (e) => {
        e.preventDefault();
        if (activeTouch !== null) return;
        activeTouch = e.changedTouches[0].identifier;
        state.buttons[7] = true;
        btn.classList.add('pressed');
    }, { passive: false });

    const endFire = (e) => {
        for (const touch of e.changedTouches) {
            if (touch.identifier === activeTouch) {
                activeTouch = null;
                state.buttons[7] = false;
                btn.classList.remove('pressed');
            }
        }
    };

    btn.addEventListener('touchend', endFire);
    btn.addEventListener('touchcancel', endFire);

    // Mouse fallback for desktop testing
    btn.addEventListener('mousedown', (e) => {
        e.preventDefault();
        state.buttons[7] = true;
        btn.classList.add('pressed');
    });
    window.addEventListener('mouseup', () => {
        if (state.buttons[7]) {
            state.buttons[7] = false;
            btn.classList.remove('pressed');
        }
    });
})();

// ---- Ready Button (A = buttons[0], press-and-release to toggle) ----
(function() {
    const btn = document.getElementById('ready-btn');
    let activeTouch = null;

    btn.addEventListener('touchstart', (e) => {
        e.preventDefault();
        if (activeTouch !== null) return;
        activeTouch = e.changedTouches[0].identifier;
        state.buttons[0] = true;
        btn.classList.add('pressed');
    }, { passive: false });

    const endReady = (e) => {
        for (const touch of e.changedTouches) {
            if (touch.identifier === activeTouch) {
                activeTouch = null;
                state.buttons[0] = false;
                btn.classList.remove('pressed');
            }
        }
    };

    btn.addEventListener('touchend', endReady);
    btn.addEventListener('touchcancel', endReady);

    // Mouse fallback for desktop testing
    btn.addEventListener('mousedown', (e) => {
        e.preventDefault();
        state.buttons[0] = true;
        btn.classList.add('pressed');
    });
    window.addEventListener('mouseup', () => {
        if (currentMode === 'lobby' && state.buttons[0]) {
            state.buttons[0] = false;
            btn.classList.remove('pressed');
        }
    });
})();

// Menu stick (navigate, same axes 0,1)
setupStick('stick-left-menu', 'knob-left-menu', 0, 1);

// ---- Select Button (menu mode, A = buttons[0]) ----
(function() {
    const btn = document.getElementById('select-btn');
    let activeTouch = null;

    btn.addEventListener('touchstart', (e) => {
        e.preventDefault();
        if (activeTouch !== null) return;
        activeTouch = e.changedTouches[0].identifier;
        state.buttons[0] = true;
        btn.classList.add('pressed');
    }, { passive: false });

    const endSelect = (e) => {
        for (const touch of e.changedTouches) {
            if (touch.identifier === activeTouch) {
                activeTouch = null;
                state.buttons[0] = false;
                btn.classList.remove('pressed');
            }
        }
    };

    btn.addEventListener('touchend', endSelect);
    btn.addEventListener('touchcancel', endSelect);

    // Mouse fallback for desktop testing
    btn.addEventListener('mousedown', (e) => {
        e.preventDefault();
        state.buttons[0] = true;
        btn.classList.add('pressed');
    });
    window.addEventListener('mouseup', () => {
        if (currentMode === 'menu' && state.buttons[0]) {
            state.buttons[0] = false;
            const b = document.getElementById('select-btn');
            if (b) b.classList.remove('pressed');
        }
    });
})();
</script>
</body>
</html>
